# Test Review

## Action Points 02.06.25:
1. **Отходим от BAD_REQUEST сценариев, т.к. на API настраивается вручную через UI.** 

2. **Валидация форм через UI на стороне Strapi (изучить их кодовую базу, покрыто ли у них этими тестами)**

3. **Попробовать снова запускать через разные браузеры, т.к. они все будут открываться напрямую в Linux через все браузеры.** 

4. **Провести эксперимент с запуском последовательных CMS тестов в 1-2 тестовых файлах (через UI, а не API заполнять данные) + остановиться на конечном варианте допустимого для нас времени выполнения тестов + изучить кодовую базу Strapi и если что полагаться на это, как компромиссный вариант.** 

	Самые популярные сценарии (для эксперимента):
	1) Создание новости
	2) Заливка документа
	3) Выставление санитарного дня

5. Эксперимент с нулевым трешхолдом

6. **Robots.txt** и **sitemap.xml** (облегчает поисковику задачу в том случае, если на сайте много страничной вложенности) - генерируются ли эти файлы по контенту сайта

	Изучить Best practices и ограничения в этих файлах (**Robots.txt** и **sitemap.xml**) 

	Поддерживается ли у нас отслеживание новостей и парсинг их поисковику согласно пейджингу новостей на сайте? Чтобы помочь поисковику не потерять наши страницы с новостями. (Попробовать прогуглить старую новость)




# API  Tests
## 1) `contact-zoo-page.spec.ts`:

### Чего не хватает:

#### 1. Проверка негативных кейсов

Не покрыты ситуации, когда:

- endpoint вызывается до создания страницы;
    
- поле `seo` или `cards` отсутствует;
    
- данные приходят пустыми или невалидными (например, массив `cards` пуст).

#### 2. Проверка не только по одному элементу в массивах

Сейчас валидируется таким образом:
`cards[0]`, `subsidizedTickets[0]`, `timetable[0]`.

**Что можно добавить:**
```
servicesBlock.cards.forEach((card, i) => {   expect(card.title).toBe(MOCK_HOME_SERVICES.cards.cards[i].title); });
```

---

#### 3. Проверки на файлы и изображения

Проверка не только того, что `url !== null`, но и, что файл по ссылке реально доступен.

При ошибке загрузки или удалении файла Strapi может оставить `url`, но он будет битым.

**Что добавить:**
```
const res = await axios.head(servicesBlock.cards[0].image.url); expect(res.status).toBe(200);
```



## 2) `discounts-page.spec.ts`

##  Чего не хватает

### 1.  Проверка негативных сценариев

- Что произойдёт, если `seo` не задан?
    
- Что если передать некорректную структуру в `PUT` (например, без `blocks`)?
### 2.  Проверка не только первого элемента в массивах

**Пример кода для доработки:**

```
categoriesBlock.discountsCards[0].rules.docs.forEach((doc, i) => {   expect(doc.text).toBe(MOCK_DISCOUNTS_CATEGORIES.discountsCards[0].rules.docs[i].text); });
```

---

### 3.  Нет HEAD-проверки доступности прикреплённого файла

### 4.  Отсутствие теста на повторный PUT

Что произойдёт, если вызвать `PUT` повторно с другими данными? Не наслаиваются ли блоки?
### 5.  Нет покрытия пустых массивов в GET

Если по какой-то причине после `DELETE` выполнить `GET` — API вернёт `null` или `[]`. Проверить допустим, что возвращается 404 страница и так далее.

**Выводы:**

| Негативные кейсы        | Добавить хотя бы 2–3: пустые поля, пропущенные обязательные блоки                                                                 |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| Массивы                 | Проверять не только `0` элемент, а `forEach()` по массиву                                                                         |
| Файлы и картинки        | Проверить валидность `url` через `axios.head()` через слушание intercept'ом поведение системы через обработку запроса на картинку |
| Повторный `PUT`         | Убедиться, что данные перезаписываются, а не наслаиваются                                                                         |
| Fallback после удаления | Протестировать `GET` после `DELETE`, ожидать пустой объект или 404                                                                |

---
**JSON cхема:**
**Проверка схемы через либу на тестирование схемы, а что если в объекте больше полей, чем те 5, которые нас интересуют.**

## 3) `documents-categories.spec.ts`

## Чего не хватает

### 1.  Нет негативных кейсов (проверки на всяческие Bad Request)

Strapi при плохом запросе должен отдавать 400. Если API принимает мусор — это баг.

### 2.  Нет явной проверки удаления (DELETE)

Тест `afterEach` подчищает данные, но это поведение не проверяется явно.

**Как улучшить:**  
Дополнить тесты таким образом, чтобы проверить, что после `DELETE` категория действительно исчезает

### 3. Нет HEAD/GET проверки доступности SEO или slug по URL

Можно проверить, что после создания категории, она доступна по эндпоинту  `/documents-categories/{slug}` — как отдельная категория

---

## Выводы

| Негативные кейсы         | Отсутствуют      | Добавить: отсутствие `title`, невалидные поля                    |
| ------------------------ | ---------------- | ---------------------------------------------------------------- |
| Проверка уникальности    | Нет              | Создать одинаковый slug и проверить конфликт/уникальность `slug` |
| DELETE-флоу              | Не проверен явно | Добавить отдельный тест на удаление категории                    |
| Проверка доступности URL | Нет              | Добавить HEAD или GET на `/documents-categories/{slug}`          |

## 5) `documents.spec.ts`

- `POST` без `title`, `category`, `files`, `description` и т.п.
    
- `POST` с невалидными ID (несуществующий categoryId, битый fileId)
    
- `DELETE` по несуществующему documentId
    
- `GET` после `DELETE`
    
### 2. Не проверяется **категория**, в которую попал документ

При создании категории, сам тест не валидирует, что документ действительно к ней принадлежит (через `category.title`, `category.id` и т.п.).

```
expect(documentTest.category.title).toBe(DOCUMENT_CATEGORY_TITLE);
```

# E2E Tests (UI + CMS)
## 11) `contact-zoo-page.spec.ts`

##  Что можно улучшить: E2E (UI) сценарии
### Проверка `SEO`-данных (description)

Для E2E важно проверять, что SEO отдается и отрисовывается в DOM:


```
await expect(page).toHaveTitle(/Челябинский зоопарк/); await expect(page.locator('meta[name="description"]')).toHaveAttribute('content', /описание/);
```

---

### Реакция при ошибках CMS (500, 404)

Проверка отрисовки страницы при падающей ошибке отсутствия данных



## 13) `documents-page.spec.ts` 

### 1. Проверка доступности документа (например, загрузка PDF)

Пользователь должен иметь возможность **открыть или скачать файл**. Сейчас проверяется только `title`, но не его функциональность.

### 2. Проверка негативных сценариев: пустые категории, несуществующие документы

Что произойдет, если:

- категория есть, а документов в ней нет?
    
- категория удалена, но документ остался?
    
- документ был, но файл удалён?


## 15) `home-page.spec.ts` 
### Проверка отсутствующих блоков

```
await axios.put(`${HOME_PAGE_API_ENDPOINT}`, { data: { blocks: [] } });  await gotoPage({ page, url: AppRoute.HOME }); await expect(page.getByText("Содержимое недоступно")).toBeVisible();
```

## 16) `news-page.spec.ts`

##  Что можно улучшить или добавить

### 1. Негативные сценарии

Тест не проверяет, как UI реагирует, если:

- Нет новостей (пустой список)
    
- Нет изображения
    
- Ошибка API (например, 500)
    
- Новости с пустыми заголовками / описаниями / innerContent
    
### 2. Интерактивность и переходы

Тест проверяет переход по ссылке, но не проверяет:

- Возврат назад
    
- Роутинг по `breadcrumbs` или кнопке "Назад"
    
- Поведение при ручном вводе URL `/news/:slug`
    

### 3. Фильтрация, пагинация, сортировка

Если в интерфейсе есть:

- Пагинация (`/news?page=2`)
    
- Фильтры по дате/категории
    
- Сортировка
    
### 4. Проверка рендеринга изображений


## 17) `visiting-rules-page.spec.ts`

### 1. Проверка UI при ошибках или отсутствии данных.

- Страница загружена, но нет блоков (пустой список).
    
- Блок есть, но в нем нет `emergencyPhonesCards`.
    
- API возвращает 500 или 403 → страница должна показать fallback (например, “Что-то пошло не так”).
    
### 2. Проверка ссылок на `tel:`

Если номера телефонов кликабельны — важно убедиться, что ссылки в DOM представлены правильно.

```
await expect(page.locator('a[href="tel:+79111234567"]')).toBeVisible();
```

# Проверка понятности документации и запуска проекта с тестами
Сделать (в частности в репе pelican-cms) .env.example более подробным и описать за что отвечает каждая переменная и как должно выглядеть правильное значение (формат и тд, какие значения допустимы, например)

**npm run test-e2e** (для запуска должна быть запущена репа pelican-ui) - при первом запуске отваливаются тесты, а при втором все становится окей.

но почему-то если запускать тесты в UI плейврайта (**npm run test-e2e:ui**), то они не отображаются, все что там есть - прикладываю скриншот, наблюдайте сами:) 
![[Pasted image 20250529142443.png]]

# Pelican UI

1. npm ci
2. npm run dev
3. npm run generate-api-types
4. npm run dev:static
5. npm run playwright-test (headless)

Все падает с ретраями 

![Pasted image 20250529144752.png](./screenshots/2020250529144752.png)

![[Pasted image 20250529144910.png]](./screenshots/20250529144910.png)

![[Pasted image 20250529145452.png]](./screenshots/20250529145452.png)

Все усыпано ретраями
![[Pasted image 20250529145749.png]](./screenshots/20250529145749.png)

Из 201 одного теста прошли только 12 и нигде не написано о том, что такое можно ожидать и как это исправить

npm run playwright-e2e-test
![[Pasted image 20250530093352.png]](./screenshots/20250530093352.png)

Мне как новому пользователю непонятно, почему все тесты не проходят и почему об этом ничего не сказано в документации. Только инфа, как их запустить по сути, и все.

Почему-то скипаются pelican-cms тесты на проверку API
![[Pasted image 20250530100245.png]](./screenshots/20250530100245.png)

Локально тесты нигде не запускаются и не проходят нормально
